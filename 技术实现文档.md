# 技术实现文档

## 2025-06-27 新增功能实现

### 1. 社交媒体链接动态配置系统

#### 1.1 数据库结构设计

**social_links 表结构：**
```sql
CREATE TABLE social_links (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  platform VARCHAR(50) NOT NULL UNIQUE,
  url TEXT,
  display_name VARCHAR(100),
  is_enabled BOOLEAN DEFAULT true,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);
```

**字段说明：**
- `id`: 主键，UUID 类型
- `platform`: 平台标识符（email, twitter, github, linkedin）
- `url`: 社交媒体链接 URL
- `display_name`: 显示名称
- `is_enabled`: 是否启用该链接
- `sort_order`: 排序顺序
- `created_at/updated_at`: 时间戳

#### 1.2 安全策略配置

**RLS 策略：**
```sql
-- 启用行级安全
ALTER TABLE social_links ENABLE ROW LEVEL SECURITY;

-- 允许所有人读取社交媒体链接
CREATE POLICY "Allow public read access" ON social_links
  FOR SELECT USING (true);

-- 只允许认证用户修改社交媒体链接
CREATE POLICY "Allow authenticated users to manage social links" ON social_links
  FOR ALL USING (auth.role() = 'authenticated');
```

#### 1.3 API 函数实现

**TypeScript 接口定义：**
```typescript
export interface SocialLink {
  id: string;
  platform: string;
  url: string | null;
  display_name: string | null;
  is_enabled: boolean;
  sort_order: number;
  created_at: string;
  updated_at: string;
}
```

**核心 API 函数：**
```typescript
// 获取启用的社交媒体链接（前台使用）
export async function getSocialLinks() {
  const { data, error } = await supabase
    .from('social_links')
    .select('*')
    .eq('is_enabled', true)
    .order('sort_order', { ascending: true });

  if (error) {
    console.error('Error fetching social links:', error);
    return [];
  }

  return data as SocialLink[];
}

// 获取所有社交媒体链接（管理后台使用）
export async function getAllSocialLinks() {
  const { data, error } = await supabase
    .from('social_links')
    .select('*')
    .order('sort_order', { ascending: true });

  if (error) {
    console.error('Error fetching all social links:', error);
    return [];
  }

  return data as SocialLink[];
}

// 更新社交媒体链接
export async function updateSocialLink(id: string, updates: Partial<SocialLink>) {
  const { data, error } = await supabase
    .from('social_links')
    .update({
      ...updates,
      updated_at: new Date().toISOString()
    })
    .eq('id', id)
    .select()
    .single();

  if (error) {
    console.error('Error updating social link:', error);
    return { success: false, error: error.message };
  }

  return { success: true, data };
}
```

#### 1.4 前台显示实现

**Layout.astro 集成：**
```astro
---
import { getPersonalInfo, getSocialLinks } from '../lib/supabase';

// 获取个人信息和社交媒体链接
const personalInfo = await getPersonalInfo();
const socialLinks = await getSocialLinks();
const displayName = personalInfo?.name || "Your Name";
---

<!-- 动态渲染社交媒体链接 -->
<footer class="glass mt-16">
  <div class="max-w-4xl mx-auto px-6 py-8 text-center">
    <div class="flex justify-center space-x-6 mb-6">
      {socialLinks.map((link) => (
        <a href={link.url || '#'} 
           class="hover:text-primary transition-colors" 
           target={link.platform === 'email' ? '_self' : '_blank'}>
          <span class="sr-only">{link.display_name}</span>
          <!-- 平台特定的 SVG 图标 -->
        </a>
      ))}
    </div>
  </div>
</footer>
```

#### 1.5 管理后台编辑功能

**HTML 结构：**
```html
<!-- 社交媒体链接编辑卡片 -->
<GlassCard class="p-6">
  <div class="mb-6">
    <h3 class="text-lg font-medium">Social Media Links</h3>
    <p class="text-sm mt-1">Configure your social media links displayed in the footer</p>
  </div>
  
  <div id="social-links-container" class="space-y-4">
    <!-- 动态生成的社交链接编辑表单 -->
  </div>
</GlassCard>
```

**JavaScript 实现：**
```javascript
// 渲染社交链接编辑界面
function renderSocialLinks() {
  const container = document.getElementById('social-links-container');
  
  container.innerHTML = socialLinks.map(link => `
    <div class="flex items-center space-x-4 p-4 glass rounded-lg">
      <div class="flex-shrink-0 w-16">
        <span class="text-sm font-medium">${link.display_name}</span>
      </div>
      <div class="flex-1">
        <input
          type="url"
          value="${link.url || ''}"
          placeholder="https://..."
          class="input"
          data-link-id="${link.id}"
          data-field="url"
        />
      </div>
      <div class="flex-shrink-0">
        <label class="flex items-center space-x-2">
          <input
            type="checkbox"
            ${link.is_enabled ? 'checked' : ''}
            data-link-id="${link.id}"
            data-field="is_enabled"
            class="rounded"
          />
          <span class="text-sm">启用</span>
        </label>
      </div>
    </div>
  `).join('');

  // 添加实时保存事件监听器
  container.querySelectorAll('input').forEach(input => {
    input.addEventListener('change', async (e) => {
      const linkId = e.target.dataset.linkId;
      const field = e.target.dataset.field;
      const value = e.target.type === 'checkbox' ? e.target.checked : e.target.value;

      try {
        const result = await updateSocialLink(linkId, { [field]: value });
        
        if (result.success) {
          // 更新本地数据并提供视觉反馈
          const linkIndex = socialLinks.findIndex(link => link.id === linkId);
          if (linkIndex !== -1) {
            socialLinks[linkIndex] = { ...socialLinks[linkIndex], [field]: value };
          }
          
          e.target.style.borderColor = 'var(--success-color)';
          setTimeout(() => {
            e.target.style.borderColor = '';
          }, 1000);
        }
      } catch (error) {
        console.error('Failed to update social link:', error);
        alert('更新失败: ' + error.message);
      }
    });
  });
}
```

### 2. 个人信息数据获取优化

#### 2.1 问题修复

**修复前的问题：**
```typescript
// 使用 .single() 在多记录情况下可能返回错误
export async function getPersonalInfo() {
  const { data, error } = await supabase
    .from('personal_info')
    .select('*')
    .single();  // 问题所在
}
```

**修复后的实现：**
```typescript
export async function getPersonalInfo() {
  const { data, error } = await supabase
    .from('personal_info')
    .select('*')
    .order('updated_at', { ascending: false })  // 按更新时间排序
    .limit(1);  // 只获取最新的一条记录

  if (error) {
    console.error('Error fetching personal info:', error);
    return null;
  }

  if (!data || data.length === 0) {
    console.log('No personal info found');
    return null;
  }

  return data[0] as PersonalInfo;  // 返回数组的第一个元素
}
```

#### 2.2 数据清理

**清理重复记录：**
```sql
-- 删除默认测试记录
DELETE FROM personal_info 
WHERE name = 'Your Name' AND title = 'Your Title';
```

### 3. 全站动态化改进

#### 3.1 Layout.astro 优化

**动态个人信息集成：**
```astro
---
import { getPersonalInfo, getSocialLinks } from '../lib/supabase';

// 获取个人信息用于全站使用
const personalInfo = await getPersonalInfo();
const displayName = personalInfo?.name || "Your Name";

// 获取社交媒体链接
const socialLinks = await getSocialLinks();
---

<!-- 导航栏动态显示 -->
<nav>
  <a href="/">{displayName}</a>
</nav>

<!-- 页脚动态显示 -->
<footer>
  <p>Copyright 2025, {displayName}</p>
</footer>
```

## 依赖关系和注意事项

### 依赖关系
1. **数据库依赖**：social_links 表必须先创建并设置 RLS 策略
2. **API 依赖**：前台显示依赖 getSocialLinks() 函数
3. **管理依赖**：管理后台依赖 getAllSocialLinks() 和 updateSocialLink() 函数

### 注意事项
1. **安全性**：确保 RLS 策略正确配置，防止未授权访问
2. **性能**：社交链接数据在每次页面加载时获取，考虑缓存策略
3. **用户体验**：管理后台提供实时保存和视觉反馈
4. **扩展性**：可以轻松添加新的社交媒体平台

### 配置步骤
1. 创建 social_links 表
2. 设置 RLS 安全策略
3. 插入默认社交媒体平台数据
4. 更新 supabase.ts 添加相关函数
5. 修改 Layout.astro 实现动态显示
6. 在管理后台添加编辑功能
7. 测试前台显示和后台编辑功能

## 历史技术实现记录

### 2025-06-26 基础架构搭建

#### 1. Supabase 项目配置
- **项目**: jodykwong's Project (mcfrfutbunhccwfotjfa)
- **区域**: us-east-2
- **数据库**: PostgreSQL with RLS
- **认证**: Supabase Auth
- **存储**: Supabase Storage

#### 2. 核心数据表设计
```sql
-- 用户配置表
profiles (
  id UUID PRIMARY KEY,
  email VARCHAR UNIQUE,
  is_admin BOOLEAN DEFAULT false,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
)

-- 内容管理表
profile_content (
  id UUID PRIMARY KEY,
  section VARCHAR(50),
  content TEXT,
  created_at TIMESTAMP,
  updated_at TIMESTAMP
)
```

#### 3. Astro 项目结构
- **框架**: Astro + TypeScript
- **样式**: CSS + glassmorphism 设计系统
- **组件**: 可重用的 Glass 组件
- **路由**: 文件系统路由

### 2025-06-26 设计系统实现

#### Apple Glassmorphism 设计系统
- **配置文件**: apple-glassmorphism-design-system.json
- **核心特性**:
  - 完整的颜色系统
  - 多层级玻璃拟态效果
  - 统一的组件样式
  - 响应式断点配置
- **组件支持**: Button、Card、Input、Modal 等
- **主题支持**: 明暗主题切换

#### 组件库实现
```astro
<!-- GlassCard.astro -->
<div class="glass-card" {...Astro.props}>
  <slot />
</div>

<!-- GlassButton.astro -->
<button class="glass-button" {...Astro.props}>
  <slot />
</button>
```

### 2025-06-26 个人信息管理系统

#### 功能特性
- **动态内容管理**: 通过管理后台编辑个人信息
- **头像上传**: 支持图片上传和管理
- **内容分区**: 多个内容区域的独立管理
- **实时预览**: 即时查看更改效果

#### 核心 API 实现
```typescript
// 个人信息管理
export async function getPersonalInfo()
export async function upsertPersonalInfo(info: PersonalInfo)

// 头像管理
export async function uploadAvatar(file: File, oldPath?: string)
export async function deleteAvatar(path: string)

// 内容管理
export async function getProfileContentBySection(section: string)
export async function upsertProfileContent(section: string, content: string)
```
