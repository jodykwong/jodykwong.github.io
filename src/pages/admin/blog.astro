---
import AdminLayout from '../../layouts/AdminLayout.astro';
import GlassCard from '../../components/GlassCard.astro';
import GlassButton from '../../components/GlassButton.astro';
import { getAllBlogPosts, getBlogCategories } from '../../lib/supabase';

export const prerender = false; // ç¡®ä¿åŠ¨æ€æ¸²æŸ“

// è·å–æ‰€æœ‰åšå®¢æ–‡ç« å’Œåˆ†ç±»
const blogPosts = await getAllBlogPosts();
const categories = await getBlogCategories();

// æ ¼å¼åŒ–æ—¥æœŸ
const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'short',
    day: 'numeric'
  });
};

// è·å–çŠ¶æ€æ ·å¼
const getStatusStyle = (published: boolean) => {
  return published 
    ? 'background: rgba(16, 185, 129, 0.1); color: #059669; border: 1px solid rgba(16, 185, 129, 0.2);'
    : 'background: rgba(245, 158, 11, 0.1); color: #d97706; border: 1px solid rgba(245, 158, 11, 0.2);';
};
---

<AdminLayout title="åšå®¢ç®¡ç†">
  <div class="space-y-6">
    <!-- é¡µé¢æ ‡é¢˜å’Œæ“ä½œ -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
      <div>
        <h1 class="text-2xl font-bold" style="color: var(--text-primary);">
          åšå®¢æ–‡ç« ç®¡ç†
        </h1>
        <p class="text-sm mt-1" style="color: var(--text-secondary);">
          ç®¡ç†åšå®¢æ–‡ç« çš„åˆ›å»ºã€ç¼–è¾‘å’Œå‘å¸ƒ
        </p>
      </div>
      
      <div class="flex gap-3">
        <GlassButton variant="secondary" href="/admin/blog/categories">
          ç®¡ç†åˆ†ç±»
        </GlassButton>
        <GlassButton variant="primary" href="/admin/blog/new">
          æ–°å»ºæ–‡ç« 
        </GlassButton>
      </div>
    </div>

    <!-- ç»Ÿè®¡å¡ç‰‡ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <GlassCard class="p-4 text-center">
        <div class="text-2xl font-bold" style="color: var(--color-primary);">
          {blogPosts.length}
        </div>
        <div class="text-sm" style="color: var(--text-secondary);">
          æ€»æ–‡ç« æ•°
        </div>
      </GlassCard>
      
      <GlassCard class="p-4 text-center">
        <div class="text-2xl font-bold" style="color: #059669;">
          {blogPosts.filter(post => post.published).length}
        </div>
        <div class="text-sm" style="color: var(--text-secondary);">
          å·²å‘å¸ƒ
        </div>
      </GlassCard>
      
      <GlassCard class="p-4 text-center">
        <div class="text-2xl font-bold" style="color: #d97706;">
          {blogPosts.filter(post => !post.published).length}
        </div>
        <div class="text-sm" style="color: var(--text-secondary);">
          è‰ç¨¿
        </div>
      </GlassCard>
      
      <GlassCard class="p-4 text-center">
        <div class="text-2xl font-bold" style="color: var(--color-primary);">
          {blogPosts.reduce((sum, post) => sum + post.view_count, 0)}
        </div>
        <div class="text-sm" style="color: var(--text-secondary);">
          æ€»æµè§ˆé‡
        </div>
      </GlassCard>
    </div>

    <!-- ç­›é€‰å’Œæœç´¢ -->
    <GlassCard class="p-4">
      <div class="flex flex-col md:flex-row gap-4">
        <div class="flex-1">
          <input
            type="text"
            id="search-posts"
            placeholder="æœç´¢æ–‡ç« æ ‡é¢˜æˆ–å†…å®¹..."
            class="w-full px-4 py-2 rounded-lg border"
            style="background: var(--bg-secondary); border-color: var(--border-light); color: var(--text-primary);"
          />
        </div>
        
        <div class="flex gap-2">
          <select
            id="filter-status"
            class="px-4 py-2 rounded-lg border"
            style="background: var(--bg-secondary); border-color: var(--border-light); color: var(--text-primary);"
          >
            <option value="">æ‰€æœ‰çŠ¶æ€</option>
            <option value="published">å·²å‘å¸ƒ</option>
            <option value="draft">è‰ç¨¿</option>
          </select>
          
          <select
            id="filter-category"
            class="px-4 py-2 rounded-lg border"
            style="background: var(--bg-secondary); border-color: var(--border-light); color: var(--text-primary);"
          >
            <option value="">æ‰€æœ‰åˆ†ç±»</option>
            {categories.map((category) => (
              <option value={category.id}>{category.name}</option>
            ))}
          </select>
        </div>
      </div>
    </GlassCard>

    <!-- æ–‡ç« åˆ—è¡¨ -->
    <GlassCard class="overflow-hidden">
      {blogPosts.length > 0 ? (
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead style="background: var(--bg-secondary);">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                  æ–‡ç« 
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                  åˆ†ç±»
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                  çŠ¶æ€
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                  ç»Ÿè®¡
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                  æ—¥æœŸ
                </th>
                <th class="px-6 py-3 text-right text-xs font-medium uppercase tracking-wider" style="color: var(--text-secondary);">
                  æ“ä½œ
                </th>
              </tr>
            </thead>
            <tbody class="divide-y" style="divide-color: var(--border-light);">
              {blogPosts.map((post) => (
                <tr class="hover:bg-opacity-50" style="hover:background: var(--bg-secondary);">
                  <!-- æ–‡ç« ä¿¡æ¯ -->
                  <td class="px-6 py-4">
                    <div class="flex items-start space-x-3">
                      {post.featured_image_url && (
                        <img
                          src={post.featured_image_url}
                          alt={post.title}
                          class="w-12 h-12 object-cover rounded-lg flex-shrink-0"
                        />
                      )}
                      <div class="min-w-0 flex-1">
                        <div class="text-sm font-medium" style="color: var(--text-primary);">
                          <a href={`/admin/blog/edit/${post.id}`} class="hover:text-blue-600">
                            {post.title}
                          </a>
                        </div>
                        {post.excerpt && (
                          <div class="text-xs mt-1" style="color: var(--text-secondary);">
                            {post.excerpt.substring(0, 80)}...
                          </div>
                        )}
                        <div class="flex items-center space-x-2 mt-1">
                          <span class="text-xs" style="color: var(--text-tertiary);">
                            {post.reading_time} åˆ†é’Ÿé˜…è¯»
                          </span>
                          {post.tags.length > 0 && (
                            <span class="text-xs" style="color: var(--text-tertiary);">
                              â€¢ {post.tags.slice(0, 2).join(', ')}
                              {post.tags.length > 2 && ` +${post.tags.length - 2}`}
                            </span>
                          )}
                        </div>
                      </div>
                    </div>
                  </td>

                  <!-- åˆ†ç±» -->
                  <td class="px-6 py-4">
                    <div class="flex flex-wrap gap-1">
                      {post.categories.slice(0, 2).map((category) => (
                        <span
                          class="inline-block px-2 py-1 text-xs rounded-full"
                          style={`background-color: ${category.color}20; color: ${category.color};`}
                        >
                          {category.name}
                        </span>
                      ))}
                      {post.categories.length > 2 && (
                        <span class="text-xs" style="color: var(--text-tertiary);">
                          +{post.categories.length - 2}
                        </span>
                      )}
                    </div>
                  </td>

                  <!-- çŠ¶æ€ -->
                  <td class="px-6 py-4">
                    <span
                      class="inline-flex px-2 py-1 text-xs font-semibold rounded-full"
                      style={getStatusStyle(post.published)}
                    >
                      {post.published ? 'å·²å‘å¸ƒ' : 'è‰ç¨¿'}
                    </span>
                  </td>

                  <!-- ç»Ÿè®¡ -->
                  <td class="px-6 py-4">
                    <div class="text-sm" style="color: var(--text-primary);">
                      {post.view_count} æµè§ˆ
                    </div>
                  </td>

                  <!-- æ—¥æœŸ -->
                  <td class="px-6 py-4">
                    <div class="text-sm" style="color: var(--text-secondary);">
                      {post.published_at ? formatDate(post.published_at) : formatDate(post.created_at)}
                    </div>
                  </td>

                  <!-- æ“ä½œ -->
                  <td class="px-6 py-4 text-right">
                    <div class="flex justify-end space-x-2">
                      <a
                        href={`/writing/${post.slug}`}
                        target="_blank"
                        class="text-xs px-3 py-1 rounded border transition-colors"
                        style="background: var(--bg-tertiary); color: var(--text-secondary); border-color: var(--border-light);"
                        title="é¢„è§ˆ"
                      >
                        é¢„è§ˆ
                      </a>
                      <a
                        href={`/admin/blog/edit/${post.id}`}
                        class="text-xs px-3 py-1 rounded border transition-colors"
                        style="background: var(--color-primary); color: white; border-color: var(--color-primary);"
                      >
                        ç¼–è¾‘
                      </a>
                      <button
                        onclick={`deleteBlogPost('${post.id}', '${post.title}')`}
                        class="text-xs px-3 py-1 rounded border transition-colors"
                        style="background: #ef4444; color: white; border-color: #ef4444;"
                      >
                        åˆ é™¤
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ) : (
        <!-- ç©ºçŠ¶æ€ -->
        <div class="p-12 text-center">
          <div class="text-6xl mb-4">ğŸ“</div>
          <h3 class="text-lg font-semibold mb-2" style="color: var(--text-primary);">
            è¿˜æ²¡æœ‰åšå®¢æ–‡ç« 
          </h3>
          <p class="mb-6" style="color: var(--text-secondary);">
            å¼€å§‹åˆ›å»ºä½ çš„ç¬¬ä¸€ç¯‡åšå®¢æ–‡ç« å§ï¼
          </p>
          <GlassButton variant="primary" href="/admin/blog/new">
            åˆ›å»ºç¬¬ä¸€ç¯‡æ–‡ç« 
          </GlassButton>
        </div>
      )}
    </GlassCard>
  </div>
</AdminLayout>

<script>
// åˆ é™¤åšå®¢æ–‡ç« 
async function deleteBlogPost(postId, postTitle) {
  if (!confirm(`ç¡®å®šè¦åˆ é™¤æ–‡ç« "${postTitle}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
    return;
  }

  try {
    const response = await fetch('/api/blog/delete', {
      method: 'DELETE',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ id: postId }),
    });

    if (response.ok) {
      alert('æ–‡ç« åˆ é™¤æˆåŠŸï¼');
      window.location.reload();
    } else {
      const error = await response.json();
      alert('åˆ é™¤å¤±è´¥: ' + error.message);
    }
  } catch (error) {
    console.error('åˆ é™¤æ–‡ç« å¤±è´¥:', error);
    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
  }
}

// æœç´¢å’Œç­›é€‰åŠŸèƒ½
document.addEventListener('DOMContentLoaded', function() {
  const searchInput = document.getElementById('search-posts');
  const statusFilter = document.getElementById('filter-status');
  const categoryFilter = document.getElementById('filter-category');
  const tableRows = document.querySelectorAll('tbody tr');

  function filterPosts() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const categoryValue = categoryFilter.value;

    tableRows.forEach(row => {
      const title = row.querySelector('td:first-child .text-sm').textContent.toLowerCase();
      const status = row.querySelector('td:nth-child(3) span').textContent.trim();
      const categories = Array.from(row.querySelectorAll('td:nth-child(2) span')).map(span => span.textContent);

      let showRow = true;

      // æœç´¢è¿‡æ»¤
      if (searchTerm && !title.includes(searchTerm)) {
        showRow = false;
      }

      // çŠ¶æ€è¿‡æ»¤
      if (statusValue) {
        const isPublished = status === 'å·²å‘å¸ƒ';
        if ((statusValue === 'published' && !isPublished) || 
            (statusValue === 'draft' && isPublished)) {
          showRow = false;
        }
      }

      // åˆ†ç±»è¿‡æ»¤ (è¿™é‡Œéœ€è¦æ›´å¤æ‚çš„é€»è¾‘ï¼Œæš‚æ—¶ç®€åŒ–)
      if (categoryValue && !categories.some(cat => cat.includes(categoryValue))) {
        // showRow = false;
      }

      row.style.display = showRow ? '' : 'none';
    });
  }

  searchInput.addEventListener('input', filterPosts);
  statusFilter.addEventListener('change', filterPosts);
  categoryFilter.addEventListener('change', filterPosts);
});

// å…¨å±€å‡½æ•°ï¼Œä¾› HTML è°ƒç”¨
window.deleteBlogPost = deleteBlogPost;
</script>

<style>
/* è¡¨æ ¼æ ·å¼ä¼˜åŒ– */
table {
  border-collapse: separate;
  border-spacing: 0;
}

th:first-child {
  border-top-left-radius: 0.5rem;
}

th:last-child {
  border-top-right-radius: 0.5rem;
}

/* å“åº”å¼è¡¨æ ¼ */
@media (max-width: 768px) {
  .overflow-x-auto {
    font-size: 0.875rem;
  }
  
  th, td {
    padding: 0.75rem 0.5rem;
  }
}
</style>
