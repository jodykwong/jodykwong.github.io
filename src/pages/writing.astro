---
import Layout from '../layouts/Layout.astro';
import NewsletterForm from '../components/NewsletterForm.astro';
import GlassCard from '../components/GlassCard.astro';
import GlassButton from '../components/GlassButton.astro';
import BlogCard from '../components/blog/BlogCard.astro';
import { getPublishedBlogPosts, getBlogCategories } from '../lib/supabase';

export const prerender = false; // ç¡®ä¿åŠ¨æ€æ¸²æŸ“

// è·å–åšå®¢æ–‡ç« å’Œåˆ†ç±»
const blogPosts = await getPublishedBlogPosts();
const categories = await getBlogCategories();

// è·å– URL å‚æ•°
const url = new URL(Astro.request.url);
const searchQuery = url.searchParams.get('search') || '';
const categoryFilter = url.searchParams.get('category') || '';

// è¿‡æ»¤æ–‡ç« 
let filteredPosts = blogPosts;

if (categoryFilter) {
  filteredPosts = blogPosts.filter(post =>
    post.categories.some(cat => cat.slug === categoryFilter)
  );
}

if (searchQuery) {
  const query = searchQuery.toLowerCase();
  filteredPosts = filteredPosts.filter(post =>
    post.title.toLowerCase().includes(query) ||
    post.excerpt?.toLowerCase().includes(query) ||
    post.tags.some(tag => tag.toLowerCase().includes(query))
  );
}

// è·å–å½“å‰åˆ†ç±»ä¿¡æ¯
const currentCategory = categoryFilter ?
  categories.find(cat => cat.slug === categoryFilter) : null;

// é¡µé¢æ ‡é¢˜
const pageTitle = currentCategory ?
  `${currentCategory.name} - å†™ä½œåˆ†äº«` :
  searchQuery ?
    `æœç´¢: ${searchQuery} - å†™ä½œåˆ†äº«` :
    'å†™ä½œåˆ†äº«';

function formatDate(dateString: string) {
  return new Date(dateString).toLocaleDateString('zh-CN', {
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
}
---

<Layout title={pageTitle}>
  <div class="max-w-6xl mx-auto px-6 py-12">
    <!-- é¡µé¢æ ‡é¢˜å’Œæè¿° -->
    <div class="text-center mb-12">
      <h1 class="text-4xl md:text-5xl font-bold mb-6 slide-up" style="color: var(--text-primary);">
        {currentCategory ? currentCategory.name : searchQuery ? `æœç´¢ç»“æœ` : 'âœï¸ å†™ä½œåˆ†äº«'}
      </h1>
      <p class="text-lg md:text-xl mb-8 slide-up" style="color: var(--text-secondary); animation-delay: 100ms;">
        {currentCategory ?
          currentCategory.description || `å…³äº${currentCategory.name}çš„æ–‡ç« ` :
          searchQuery ?
            `æ‰¾åˆ° ${filteredPosts.length} ç¯‡ç›¸å…³æ–‡ç« ` :
            'åˆ†äº«æŠ€æœ¯è§è§£ã€äº§å“æ€è€ƒå’Œåˆ›ä¸šå¿ƒå¾—'
        }
      </p>
    </div>

    <!-- æœç´¢å’Œç­›é€‰ -->
    <div class="mb-8">
      <GlassCard class="p-6">
        <div class="flex flex-col md:flex-row gap-4">
          <!-- æœç´¢æ¡† -->
          <div class="flex-1">
            <form method="GET" class="relative">
              <input
                type="text"
                name="search"
                value={searchQuery}
                placeholder="æœç´¢æ–‡ç« æ ‡é¢˜ã€å†…å®¹æˆ–æ ‡ç­¾..."
                class="w-full px-4 py-3 pr-12 rounded-lg border"
                style="background: var(--bg-secondary); border-color: var(--border-light); color: var(--text-primary);"
              />
              <button
                type="submit"
                class="absolute right-3 top-1/2 transform -translate-y-1/2"
                style="color: var(--text-tertiary);"
              >
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                </svg>
              </button>
              {categoryFilter && (
                <input type="hidden" name="category" value={categoryFilter} />
              )}
            </form>
          </div>

          <!-- åˆ†ç±»ç­›é€‰ -->
          <div class="flex flex-wrap gap-2">
            <a
              href="/writing"
              class={`category-filter ${!categoryFilter ? 'active' : ''}`}
            >
              å…¨éƒ¨
            </a>
            {categories.map((category) => (
              <a
                href={`/writing?category=${category.slug}`}
                class={`category-filter ${categoryFilter === category.slug ? 'active' : ''}`}
                style={categoryFilter === category.slug ?
                  `background-color: ${category.color}20; color: ${category.color}; border-color: ${category.color};` :
                  ''
                }
              >
                {category.name}
              </a>
            ))}
          </div>
        </div>
      </GlassCard>
    </div>

    <!-- æ–‡ç« åˆ—è¡¨ -->
    {filteredPosts.length > 0 ? (
      <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
        {filteredPosts.map((post, index) => (
          <div class="slide-up" style={`animation-delay: ${index * 100}ms;`}>
            <BlogCard post={post} />
          </div>
        ))}
      </div>
    ) : (
      <!-- ç©ºçŠ¶æ€ -->
      <GlassCard class="p-12 text-center">
        <div class="text-6xl mb-6">ğŸ“</div>
        <h2 class="text-2xl font-semibold mb-4" style="color: var(--text-primary);">
          {searchQuery || categoryFilter ? 'æ²¡æœ‰æ‰¾åˆ°ç›¸å…³æ–‡ç« ' : 'æš‚æ— æ–‡ç« '}
        </h2>
        <p class="mb-6" style="color: var(--text-secondary); line-height: 1.6;">
          {searchQuery || categoryFilter ?
            'å°è¯•è°ƒæ•´æœç´¢å…³é”®è¯æˆ–é€‰æ‹©å…¶ä»–åˆ†ç±»' :
            'æ–‡ç« æ­£åœ¨å‡†å¤‡ä¸­ï¼Œæ•¬è¯·æœŸå¾…ç²¾å½©å†…å®¹ï¼'
          }
        </p>
        {(searchQuery || categoryFilter) && (
          <a
            href="/writing"
            class="inline-flex items-center px-6 py-3 rounded-lg font-medium transition-colors"
            style="background: var(--color-primary); color: white;"
          >
            æŸ¥çœ‹æ‰€æœ‰æ–‡ç« 
          </a>
        )}
      </GlassCard>
    )}

    <!-- è®¢é˜…åŒºåŸŸ -->
    <GlassCard class="p-8 mt-8 text-center slide-up" style="animation-delay: 400ms;">
      <h2 class="text-2xl font-semibold mb-4" style="color: var(--text-primary);">
        ğŸ“¬ Subscribe to updates
      </h2>
      <p class="mb-6" style="color: var(--text-secondary); line-height: 1.6;">
        Get notified when I publish new posts about software development and entrepreneurship.
      </p>
      <NewsletterForm />

      <div class="flex justify-center gap-4 mt-6">
        <GlassButton variant="secondary" size="sm" href="/projects">
          View Projects
        </GlassButton>
        <GlassButton variant="secondary" size="sm" href="/about">
          About Me
        </GlassButton>
      </div>
    </GlassCard>
  </div>
</Layout>

<style>
.category-filter {
  display: inline-block;
  padding: 0.5rem 1rem;
  border-radius: 9999px;
  font-size: 0.875rem;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.2s ease;
  background: var(--bg-tertiary);
  color: var(--text-secondary);
  border: 1px solid var(--border-light);
}

.category-filter:hover {
  background: var(--bg-secondary);
  color: var(--text-primary);
  transform: translateY(-1px);
}

.category-filter.active {
  background: var(--color-primary);
  color: white;
  border-color: var(--color-primary);
}

/* åŠ¨ç”»æ•ˆæœ */
.slide-up {
  opacity: 0;
  transform: translateY(20px);
  animation: slideUp 0.6s ease forwards;
}

@keyframes slideUp {
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* å“åº”å¼è®¾è®¡ */
@media (max-width: 768px) {
  .category-filter {
    font-size: 0.75rem;
    padding: 0.375rem 0.75rem;
  }
}
</style>
