<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é…ç½®éªŒè¯å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background-color: #f8fafc;
        }
        .test-section h3 {
            margin-top: 0;
            color: #1e293b;
        }
        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            margin-left: 10px;
        }
        .status.pass {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status.fail {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .status.pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        button {
            background-color: #2563eb;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #1d4ed8;
        }
        button:disabled {
            background-color: #9ca3af;
            cursor: not-allowed;
        }
        .details {
            margin-top: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        .error {
            color: #dc2626;
        }
        .success {
            color: #059669;
        }
        .info {
            color: #2563eb;
        }
        pre {
            background-color: #1e293b;
            color: #e2e8f0;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ” Supabase é…ç½®éªŒè¯å·¥å…·</h1>
        <p>ä½¿ç”¨ä½ çš„å®é™… Supabase é…ç½®è¿›è¡Œå…¨é¢éªŒè¯</p>
        
        <div class="test-section">
            <h3>1. ç¯å¢ƒå˜é‡æ£€æŸ¥ <span id="env-status" class="status pending">å¾…æ£€æŸ¥</span></h3>
            <button onclick="checkEnvironment()">æ£€æŸ¥ç¯å¢ƒå˜é‡</button>
            <div id="env-details" class="details" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>2. Supabase è¿æ¥æµ‹è¯• <span id="connection-status" class="status pending">å¾…æ£€æŸ¥</span></h3>
            <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
            <div id="connection-details" class="details" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>3. æ•°æ®åº“è¡¨æ£€æŸ¥ <span id="tables-status" class="status pending">å¾…æ£€æŸ¥</span></h3>
            <button onclick="checkTables()">æ£€æŸ¥æ•°æ®è¡¨</button>
            <div id="tables-details" class="details" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>4. ç®¡ç†å‘˜è´¦æˆ·éªŒè¯ <span id="admin-status" class="status pending">å¾…æ£€æŸ¥</span></h3>
            <button onclick="checkAdminUser()">æ£€æŸ¥ç®¡ç†å‘˜è´¦æˆ·</button>
            <div id="admin-details" class="details" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>5. ç™»å½•åŠŸèƒ½æµ‹è¯• <span id="login-status" class="status pending">å¾…æ£€æŸ¥</span></h3>
            <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
            <div id="login-details" class="details" style="display: none;"></div>
        </div>
        
        <div class="test-section">
            <h3>6. å®Œæ•´éªŒè¯ <span id="full-status" class="status pending">å¾…æ£€æŸ¥</span></h3>
            <button onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
            <div id="full-details" class="details" style="display: none;"></div>
        </div>
        
        <div class="test-section" style="background-color: #dbeafe;">
            <h3>ğŸ“‹ ä¿®å¤æŒ‡å—</h3>
            <div id="fix-guide">
                <p>ç‚¹å‡»ä¸Šé¢çš„æµ‹è¯•æŒ‰é’®æ¥è¯Šæ–­é—®é¢˜ï¼Œè¿™é‡Œä¼šæ˜¾ç¤ºç›¸åº”çš„ä¿®å¤å»ºè®®ã€‚</p>
            </div>
        </div>
    </div>

    <script>
        // ä½ çš„ Supabase é…ç½®
        const SUPABASE_URL = 'https://mcfrfutbunhccwfotjfa.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jZnJmdXRidW5oY2N3Zm90amZhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA4MzIzODYsImV4cCI6MjA2NjQwODM4Nn0.4fFg8uc_0aukJSksQlW4ljV5ZfJK-lW9HPqw3s0FTw0';
        
        let supabase;
        
        function updateStatus(elementId, status, message = '') {
            const element = document.getElementById(elementId);
            element.className = `status ${status}`;
            element.textContent = status === 'pass' ? 'âœ… é€šè¿‡' : status === 'fail' ? 'âŒ å¤±è´¥' : 'â³ æ£€æŸ¥ä¸­';
            
            if (message) {
                const detailsId = elementId.replace('-status', '-details');
                const detailsElement = document.getElementById(detailsId);
                detailsElement.innerHTML = message;
                detailsElement.style.display = 'block';
            }
        }
        
        function checkEnvironment() {
            updateStatus('env-status', 'pending');
            
            let details = '<div class="info">æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®...</div>';
            
            // æ£€æŸ¥ URL æ ¼å¼
            if (!SUPABASE_URL || !SUPABASE_URL.startsWith('https://') || !SUPABASE_URL.includes('.supabase.co')) {
                details += '<div class="error">âŒ Supabase URL æ ¼å¼ä¸æ­£ç¡®</div>';
                updateStatus('env-status', 'fail', details);
                return false;
            }
            
            // æ£€æŸ¥ Key æ ¼å¼
            if (!SUPABASE_ANON_KEY || !SUPABASE_ANON_KEY.startsWith('eyJ')) {
                details += '<div class="error">âŒ Supabase Anon Key æ ¼å¼ä¸æ­£ç¡®</div>';
                updateStatus('env-status', 'fail', details);
                return false;
            }
            
            details += '<div class="success">âœ… URL æ ¼å¼æ­£ç¡®: ' + SUPABASE_URL + '</div>';
            details += '<div class="success">âœ… Anon Key æ ¼å¼æ­£ç¡®</div>';
            details += '<div class="info">ğŸ’¡ ç¯å¢ƒå˜é‡é…ç½®æ­£ç¡®</div>';
            
            updateStatus('env-status', 'pass', details);
            return true;
        }
        
        async function testConnection() {
            updateStatus('connection-status', 'pending');
            
            let details = '<div class="info">åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯...</div>';
            
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                details += '<div class="success">âœ… Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–æˆåŠŸ</div>';
                
                // æµ‹è¯•åŸºæœ¬è¿æ¥
                details += '<div class="info">æµ‹è¯•æ•°æ®åº“è¿æ¥...</div>';
                const { data, error } = await supabase.from('profiles').select('count').limit(1);
                
                if (error) {
                    details += '<div class="error">âŒ è¿æ¥å¤±è´¥: ' + error.message + '</div>';
                    
                    if (error.message.includes('relation "profiles" does not exist')) {
                        details += '<div class="error">ğŸ’¡ æ•°æ®è¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦è¿è¡Œæ•°æ®åº“è¿ç§»</div>';
                    }
                    
                    updateStatus('connection-status', 'fail', details);
                    return false;
                } else {
                    details += '<div class="success">âœ… æ•°æ®åº“è¿æ¥æˆåŠŸ</div>';
                    updateStatus('connection-status', 'pass', details);
                    return true;
                }
            } catch (error) {
                details += '<div class="error">âŒ è¿æ¥æµ‹è¯•å¤±è´¥: ' + error.message + '</div>';
                updateStatus('connection-status', 'fail', details);
                return false;
            }
        }
        
        async function checkTables() {
            updateStatus('tables-status', 'pending');
            
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            
            let details = '<div class="info">æ£€æŸ¥å¿…è¦çš„æ•°æ®è¡¨...</div>';
            
            const requiredTables = [
                'profiles',
                'posts', 
                'projects',
                'newsletter_subscribers',
                'metrics',
                'profile_content',
                'admin_logs'
            ];
            
            let allTablesExist = true;
            
            for (const table of requiredTables) {
                try {
                    const { data, error } = await supabase.from(table).select('*').limit(1);
                    
                    if (error) {
                        details += '<div class="error">âŒ è¡¨ "' + table + '" ä¸å­˜åœ¨</div>';
                        allTablesExist = false;
                    } else {
                        details += '<div class="success">âœ… è¡¨ "' + table + '" å­˜åœ¨</div>';
                    }
                } catch (error) {
                    details += '<div class="error">âŒ æ£€æŸ¥è¡¨ "' + table + '" æ—¶å‡ºé”™: ' + error.message + '</div>';
                    allTablesExist = false;
                }
            }
            
            if (!allTablesExist) {
                details += '<div class="error">ğŸ’¡ éœ€è¦è¿è¡Œæ•°æ®åº“è¿ç§»è„šæœ¬</div>';
                updateStatus('tables-status', 'fail', details);
                return false;
            } else {
                details += '<div class="success">ğŸ‰ æ‰€æœ‰å¿…è¦çš„æ•°æ®è¡¨éƒ½å­˜åœ¨</div>';
                updateStatus('tables-status', 'pass', details);
                return true;
            }
        }
        
        async function checkAdminUser() {
            updateStatus('admin-status', 'pending');
            
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            
            let details = '<div class="info">æ£€æŸ¥ç®¡ç†å‘˜è´¦æˆ· 149018385@qq.com...</div>';
            
            try {
                // æ£€æŸ¥ profiles è¡¨ä¸­çš„ç”¨æˆ·
                const { data, error } = await supabase
                    .from('profiles')
                    .select('id, email, is_admin, created_at')
                    .eq('email', '149018385@qq.com');
                
                if (error) {
                    details += '<div class="error">âŒ æŸ¥è¯¢ç”¨æˆ·å¤±è´¥: ' + error.message + '</div>';
                    updateStatus('admin-status', 'fail', details);
                    return false;
                }
                
                if (data.length === 0) {
                    details += '<div class="error">âŒ ç”¨æˆ· 149018385@qq.com ä¸å­˜åœ¨</div>';
                    details += '<div class="error">ğŸ’¡ éœ€è¦åœ¨ Supabase Dashboard > Authentication > Users ä¸­åˆ›å»ºç”¨æˆ·</div>';
                    updateStatus('admin-status', 'fail', details);
                    return false;
                }
                
                const user = data[0];
                details += '<div class="success">âœ… ç”¨æˆ·å­˜åœ¨: ' + user.email + '</div>';
                details += '<div class="info">ç”¨æˆ· ID: ' + user.id + '</div>';
                details += '<div class="info">åˆ›å»ºæ—¶é—´: ' + new Date(user.created_at).toLocaleString() + '</div>';
                
                if (user.is_admin) {
                    details += '<div class="success">âœ… ç”¨æˆ·å…·æœ‰ç®¡ç†å‘˜æƒé™</div>';
                    updateStatus('admin-status', 'pass', details);
                    return true;
                } else {
                    details += '<div class="error">âŒ ç”¨æˆ·æ²¡æœ‰ç®¡ç†å‘˜æƒé™</div>';
                    details += '<div class="error">ğŸ’¡ éœ€è¦è¿è¡Œ SQL: UPDATE profiles SET is_admin = true WHERE email = \'149018385@qq.com\';</div>';
                    updateStatus('admin-status', 'fail', details);
                    return false;
                }
                
            } catch (error) {
                details += '<div class="error">âŒ æ£€æŸ¥ç”¨æˆ·æ—¶å‡ºé”™: ' + error.message + '</div>';
                updateStatus('admin-status', 'fail', details);
                return false;
            }
        }
        
        async function testLogin() {
            updateStatus('login-status', 'pending');
            
            if (!supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }
            
            let details = '<div class="info">æµ‹è¯•ç™»å½• 149018385@qq.com / admin123...</div>';
            
            try {
                // å°è¯•ç™»å½•
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: '149018385@qq.com',
                    password: 'admin123'
                });
                
                if (error) {
                    details += '<div class="error">âŒ ç™»å½•å¤±è´¥: ' + error.message + '</div>';
                    
                    if (error.message.includes('Invalid login credentials')) {
                        details += '<div class="error">ğŸ’¡ å¯èƒ½åŸå› : å¯†ç é”™è¯¯æˆ–ç”¨æˆ·ä¸å­˜åœ¨</div>';
                    } else if (error.message.includes('Email not confirmed')) {
                        details += '<div class="error">ğŸ’¡ é‚®ç®±æœªç¡®è®¤ï¼Œè¯·åœ¨ Supabase Dashboard ä¸­ç¡®è®¤ç”¨æˆ·é‚®ç®±</div>';
                    }
                    
                    updateStatus('login-status', 'fail', details);
                    return false;
                } else {
                    details += '<div class="success">âœ… ç™»å½•æˆåŠŸï¼</div>';
                    details += '<div class="info">ç”¨æˆ· ID: ' + data.user.id + '</div>';
                    
                    // æ£€æŸ¥ç®¡ç†å‘˜æƒé™
                    const { data: profile } = await supabase
                        .from('profiles')
                        .select('is_admin')
                        .eq('id', data.user.id)
                        .single();
                    
                    if (profile?.is_admin) {
                        details += '<div class="success">âœ… ç®¡ç†å‘˜æƒé™éªŒè¯æˆåŠŸï¼</div>';
                        details += '<div class="success">ğŸ‰ å¯ä»¥æ­£å¸¸è®¿é—®ç®¡ç†åå°ï¼</div>';
                        updateStatus('login-status', 'pass', details);
                        
                        // ç™»å‡º
                        await supabase.auth.signOut();
                        return true;
                    } else {
                        details += '<div class="error">âŒ ç”¨æˆ·ç™»å½•æˆåŠŸä½†æ²¡æœ‰ç®¡ç†å‘˜æƒé™</div>';
                        updateStatus('login-status', 'fail', details);
                        
                        // ç™»å‡º
                        await supabase.auth.signOut();
                        return false;
                    }
                }
            } catch (error) {
                details += '<div class="error">âŒ æµ‹è¯•ç™»å½•æ—¶å‡ºé”™: ' + error.message + '</div>';
                updateStatus('login-status', 'fail', details);
                return false;
            }
        }
        
        async function runFullTest() {
            updateStatus('full-status', 'pending');
            
            let details = '<div class="info">å¼€å§‹å®Œæ•´éªŒè¯...</div>';
            
            const results = {
                env: false,
                connection: false,
                tables: false,
                admin: false,
                login: false
            };
            
            // ä¾æ¬¡è¿è¡Œæ‰€æœ‰æµ‹è¯•
            results.env = checkEnvironment();
            
            if (results.env) {
                results.connection = await testConnection();
                
                if (results.connection) {
                    results.tables = await checkTables();
                    
                    if (results.tables) {
                        results.admin = await checkAdminUser();
                        
                        if (results.admin) {
                            results.login = await testLogin();
                        }
                    }
                }
            }
            
            // ç”Ÿæˆæ€»ç»“
            const passed = Object.values(results).filter(r => r).length;
            const total = Object.keys(results).length;
            
            details += '<div class="info">æµ‹è¯•å®Œæˆ: ' + passed + '/' + total + ' é¡¹é€šè¿‡</div>';
            
            if (passed === total) {
                details += '<div class="success">ğŸ‰ æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ä½ ç°åœ¨å¯ä»¥ä½¿ç”¨ 149018385@qq.com / admin123 ç™»å½•ç®¡ç†åå°äº†ï¼</div>';
                details += '<div class="success">è®¿é—®: http://localhost:4321/admin/login</div>';
                updateStatus('full-status', 'pass', details);
                
                // æ›´æ–°ä¿®å¤æŒ‡å—
                document.getElementById('fix-guide').innerHTML = '<div class="success">ğŸ‰ é…ç½®å®Œæˆï¼ç°åœ¨å¯ä»¥æ­£å¸¸ä½¿ç”¨ç®¡ç†åå°äº†ã€‚</div>';
            } else {
                details += '<div class="error">âŒ éƒ¨åˆ†æµ‹è¯•å¤±è´¥ï¼Œè¯·æŸ¥çœ‹ä¸Šé¢çš„è¯¦ç»†ä¿¡æ¯è¿›è¡Œä¿®å¤</div>';
                updateStatus('full-status', 'fail', details);
                
                // ç”Ÿæˆä¿®å¤æŒ‡å—
                generateFixGuide(results);
            }
        }
        
        function generateFixGuide(results) {
            let guide = '<h4>ğŸ”§ ä¿®å¤æ­¥éª¤ï¼š</h4>';
            
            if (!results.env) {
                guide += '<p>1. âŒ ç¯å¢ƒå˜é‡é…ç½®æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ .env æ–‡ä»¶</p>';
            }
            
            if (!results.connection) {
                guide += '<p>2. âŒ æ— æ³•è¿æ¥åˆ° Supabaseï¼Œè¯·æ£€æŸ¥é¡¹ç›®çŠ¶æ€å’Œç½‘ç»œè¿æ¥</p>';
            }
            
            if (!results.tables) {
                guide += '<p>3. âŒ æ•°æ®è¡¨ä¸å­˜åœ¨ï¼Œè¯·è¿è¡Œæ•°æ®åº“è¿ç§»ï¼š</p>';
                guide += '<pre>åœ¨ Supabase SQL Editor ä¸­è¿è¡Œï¼š\n1. supabase/migrations/001_initial_schema.sql\n2. supabase/migrations/002_admin_system.sql</pre>';
            }
            
            if (!results.admin) {
                guide += '<p>4. âŒ ç®¡ç†å‘˜è´¦æˆ·é—®é¢˜ï¼š</p>';
                guide += '<pre>åœ¨ Supabase Dashboard > Authentication > Users ä¸­ï¼š\n1. åˆ›å»ºç”¨æˆ· 149018385@qq.com / admin123\n2. å‹¾é€‰ "Auto Confirm User"\n3. åœ¨ SQL Editor ä¸­è¿è¡Œï¼š\n   UPDATE profiles SET is_admin = true WHERE email = \'149018385@qq.com\';</pre>';
            }
            
            if (!results.login) {
                guide += '<p>5. âŒ ç™»å½•åŠŸèƒ½æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ç”¨æˆ·å¯†ç å’Œæƒé™è®¾ç½®</p>';
            }
            
            document.getElementById('fix-guide').innerHTML = guide;
        }
        
        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºé…ç½®ä¿¡æ¯
        window.addEventListener('load', () => {
            document.getElementById('fix-guide').innerHTML = `
                <p><strong>å½“å‰é…ç½®ï¼š</strong></p>
                <p>Supabase URL: ${SUPABASE_URL}</p>
                <p>ç®¡ç†å‘˜é‚®ç®±: 149018385@qq.com</p>
                <p>ç®¡ç†å‘˜å¯†ç : admin123</p>
                <p><strong>å»ºè®®ï¼š</strong>ç‚¹å‡»"è¿è¡Œå®Œæ•´æµ‹è¯•"è¿›è¡Œå…¨é¢éªŒè¯</p>
            `;
        });
    </script>
</body>
</html>
